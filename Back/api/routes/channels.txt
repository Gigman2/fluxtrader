"""Channel API routes - handles HTTP request/response only."""

from flask import request, jsonify
from uuid import UUID

from api import api_bp
from api.utils import get_db, db_session_required
from api.schemas import ChannelSchema
from services.channel_service import ChannelService
from config.exceptions_handler import DatabaseError, ValidationError


@api_bp.route('/channels', methods=['GET'])
@db_session_required
def list_channels():
    """Get all channels with optional filtering."""
    try:
        db = get_db()
        
        # Parse query parameters
        status = request.args.get('status')
        account_id_str = request.args.get('account_id')
        orphaned = request.args.get('orphaned', '').lower() == 'true'
        
        # Convert account_id to UUID if provided
        account_id = None
        if account_id_str:
            try:
                account_id = UUID(account_id_str)
            except ValueError:
                return jsonify({
                    'success': False,
                    'error': 'Invalid account_id format'
                }), 400
        
        # Get channels via service
        channels = ChannelService.get_all_channels(
            db,
            status=status,
            account_id=account_id,
            orphaned_only=orphaned
        )
        
        return jsonify({
            'success': True,
            'data': [ChannelSchema.serialize(channel) for channel in channels],
            'count': len(channels)
        }), 200
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels/<uuid:channel_id>', methods=['GET'])
@db_session_required
def get_channel(channel_id):
    """Get a specific channel by ID."""
    try:
        db = get_db()
        channel = ChannelService.get_channel_by_id(db, channel_id)
        
        if not channel:
            return jsonify({
                'success': False,
                'error': 'Channel not found'
            }), 404
        
        return jsonify({
            'success': True,
            'data': ChannelSchema.serialize(channel)
        }), 200
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels', methods=['POST'])
@db_session_required
def create_channel():
    """Create a new channel."""
    try:
        data = request.get_json()
        if not data:
            return jsonify({
                'success': False,
                'error': 'Request body is required'
            }), 400
        
        # Validate input
        validated_data = ChannelSchema.validate_create(data)
        
        # Convert account_id to UUID if provided
        if 'account_id' in validated_data and validated_data['account_id']:
            try:
                validated_data['account_id'] = UUID(validated_data['account_id'])
            except ValueError:
                return jsonify({
                    'success': False,
                    'error': 'Invalid account_id format'
                }), 400
        
        # Create channel via service
        db = get_db()
        channel = ChannelService.create_channel(db, validated_data)
        
        return jsonify({
            'success': True,
            'data': ChannelSchema.serialize(channel),
            'message': 'Channel created successfully'
        }), 201
    
    except ValueError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400
    except ValidationError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 404
    except DatabaseError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 409
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels/<uuid:channel_id>', methods=['PUT'])
@db_session_required
def update_channel(channel_id):
    """Update an existing channel."""
    try:
        data = request.get_json()
        if not data:
            return jsonify({
                'success': False,
                'error': 'Request body is required'
            }), 400
        
        # Validate input
        validated_data = ChannelSchema.validate_update(data)
        
        # Convert account_id to UUID if provided
        if 'account_id' in validated_data and validated_data['account_id']:
            try:
                validated_data['account_id'] = UUID(validated_data['account_id'])
            except ValueError:
                return jsonify({
                    'success': False,
                    'error': 'Invalid account_id format'
                }), 400
        
        # Update channel via service
        db = get_db()
        channel = ChannelService.update_channel(db, channel_id, validated_data)
        
        return jsonify({
            'success': True,
            'data': ChannelSchema.serialize(channel),
            'message': 'Channel updated successfully'
        }), 200
    
    except ValidationError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 404
    except ValueError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels/<uuid:channel_id>', methods=['DELETE'])
@db_session_required
def delete_channel(channel_id):
    """Delete a channel."""
    try:
        db = get_db()
        ChannelService.delete_channel(db, channel_id)
        
        return jsonify({
            'success': True,
            'message': 'Channel deleted successfully'
        }), 200
    
    except ValidationError as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 404
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels/orphaned', methods=['GET'])
@db_session_required
def list_orphaned_channels():
    """Get all orphaned channels."""
    try:
        db = get_db()
        channels = ChannelService.get_orphaned_channels(db)
        
        return jsonify({
            'success': True,
            'data': [ChannelSchema.serialize(channel) for channel in channels],
            'count': len(channels)
        }), 200
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@api_bp.route('/channels/<uuid:channel_id>/reassign', methods=['POST'])
@db_session_required
def reassign_channel(channel_id):
    """Reassign an orphaned channel to a new account."""
    try:
        data = request.get_json()
        if not data or 'account_id' not in data:
            return jsonify({
                'success': False,
                'error': 'account_id is required'
            }), 400
        
        try:
            account_id = UUID(data['account_id'])
        except ValueError:
            return jsonify({
                'success': False,
                'error': 'Invalid account_id format'
            }), 400
        
        # Reassign channel via service
        db = get_db()
        channel = ChannelService.reassign_orphaned_channel(db, channel_id, account_id)
        
        return jsonify({
            'success': True,
            'data': ChannelSchema.serialize(channel),
            'message': 'Channel reassigned successfully'
        }), 200
    
    except ValidationError as e:
        error_msg = str(e)
        if 'not found' in error_msg.lower():
            status_code = 404
        elif 'not orphaned' in error_msg.lower():
            status_code = 400
        else:
            status_code = 400
        return jsonify({
            'success': False,
            'error': error_msg
        }), status_code
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

